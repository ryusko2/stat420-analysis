---
title: "STAT-420 Data Analysis Project"
output: 
  html_document:
    toc: yes
    toc_depth: 2
    theme: simplex
---

###*Oh! The agony of an airline statistician*
####8/4/2017

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 1, digits = 4, width = 80)

#seed
epoch = 19700101 #The Epoch! https://en.wikipedia.org/wiki/Unix_time
set.seed(epoch)
```

## Introduction

[This linked repository](https://github.com/ryusko2/stat420-analysis) contains our working files for this data analysis project.

Contributing team members include:

* dakline2@illinois.edu ~ Doug Kline
* anushav3@illinois.edu ~ Anusha Varadharajan
* ryusko2@illinois.edu  ~ Ryan Yusko

We have selected a dataset representing all US domestic flights from 1990 to 2009:

[http://academictorrents.com/details/a2ccf94bbb4af222bf8e69dad60a68a29f310d9a](http://academictorrents.com/details/a2ccf94bbb4af222bf8e69dad60a68a29f310d9a)

A summary of the raw data is presented here:
  
| Short Name             | Type    | Description                                                                                              |
|------------------------|---------|----------------------------------------------------------------------------------------------------------|
| Origin                 | String  | Three letter airport code of the origin airport                                                          |
| Destination            | String  | Three letter airport code of the destination airport                                                     |
| Origin City            | String  | Origin city name                                                                                         |
| Destination City       | String  | Destination city name                                                                                    |
| Passengers             | Integer | Number of passengers transported from origin to destination                                              |
| Seats                  | Integer | Number of seats available on flights from origin to destination                                          |
| Flights                | Integer | Number of flights between origin and destination (multiple records for one month, many with flights > 1) |
| Distance               | Integer | Distance (to nearest mile) flown between origin and destination                                          |
| Fly Date               | Integer | The date (yyyymm) of flight                                                                              |
| Origin Population      | Integer | Origin city's population as reported by US Census                                                        |
| Destination Population | Integer | Destination city's population as reported by US Census                                                   |

We hope to explore interactions and possibly model predictions for the response variable(s) `Passengers`, `Seats`, and/or `Flights`.  We have already observed high correlation between `Flights` and both `Seats` and `Passengers`, so we may not need all three of these variables in our model.  This correlation is expected because, as more flights are flown between destinations, there are more seats available, and only a certain number of passengers may fly in those seats.

We have also considered confirming busy travel months by analyzing the response to `date`.

The raw data was cleaned, and several potential predictor variables have been added:

| Predictor     | Coded as                    | Explanation                                             |
|---------------|-----------------------------|---------------------------------------------------------|
| `origin_regn` | *See region codes, below    | Region where flight originated                          |
| `origin_subr` | *See subregion codes, below | Subregion where flight originated                       |
| `dest_regn`   | *See region codes, below    | Destination region                                      |
| `dest_subr`   | *See subregion codes, below | Destination subregion                                   |
| `intra_regn`  | TRUE | FALSE                | Did flight takeoff and land in same region?             |
| `intra_subr`  | TRUE | FALSE                | Did flight takeoff and land in same subregion?          |
| `month`       | 1:12                        | Integer representation of month when flight(s) occurred |
| `month.chr`   | {"Jan", "Feb", ... , "Dec"} | String representation of month when flight(s) occurred  |

Regions as defined by the [U.S. Census Bureau](https://www2.census.gov/geo/pdfs/maps-data/maps/reference/us_regdiv.pdf) are coded as follows:

| Region (code)  | Subregions Included                                    |
|----------------|--------------------------------------------------------|
| Northeast (NE) | New England, Middle Atlantic                           |
| Midwest (MW)   | East North Central, West North Central                 |
| South (S)      | South Atlantic, East South Central, West South Central |
| West (W)       | Mountain, Pacific                                      |

Subregions as defined by the [U.S. Census Bureau](https://www2.census.gov/geo/pdfs/maps-data/maps/reference/us_regdiv.pdf) are coded as follows:

| Subregion (code)         | States Included*                    |
|--------------------------|-------------------------------------|
| New England (NE)         | CT, ME, MA, NH, RI, VT              |
| Middle Atlantic (MA)     | NJ, NY, PA                          |
| East North Central (ENC) | IL, IN, MI, OH, WI                  |
| West North Central (WNC) | IA, KS, MN, MO, NE, ND, SD          |
| South Atlantic (SA)      | DE, DC*, FL, GA, MD, NC, SC, VA, WV |
| East South Central (ESC) | AL, KY, MS, TN                      |
| West South Central (WSC) | AR, LA, OK, TX                      |
| Mountain (M)             | AZ, CO, ID, MT, NV, NM, UT, WY      |
| Pacific (P)              | AK, CA, HI, OR, WA                  |

\*Although Washington DC is not technically a state, it is home to two airports included in this dataset: DCA (Ronald Reagan Washington National), and IAD (Washington Dulles International).  Washington DC is in the *South Atlantic* subregion of the *South* region.

A random sample of our [cleaned] data is provided below:

```{r warning = FALSE, echo = FALSE, cache = TRUE}
#load data
flight_edges = readr::read_csv("flight_edges.csv", col_types = "icccccccccclliiiiiiicii")

#remove first column
flight_edges = flight_edges[,2:ncol(flight_edges)]

#set up factor variables
flight_edges$year = as.factor(flight_edges$year)
flight_edges$origin_state = as.factor(flight_edges$origin_state)
flight_edges$dest_state = as.factor(flight_edges$dest_state)
flight_edges$origin_regn = as.factor(flight_edges$origin_regn)
flight_edges$origin_subr = as.factor(flight_edges$origin_subr)
flight_edges$dest_regn = as.factor(flight_edges$dest_regn)
flight_edges$dest_subr = as.factor(flight_edges$dest_subr)
flight_edges$intra_regn = as.factor(flight_edges$intra_regn)
flight_edges$intra_subr = as.factor(flight_edges$intra_subr)
flight_edges$month.chr = as.factor(flight_edges$month.chr)

#sample some data, removing columns containing `city`, ICAOs, and the raw `date`
knitr::kable(flight_edges[runif(5, min = 1, max = nrow(flight_edges)),-c(1:3, 7, 17)])
```

##Setup

Random sampling and exploring the data has revealed two groups of observations that do not make sense, from an airline's perspective, when predicting `passengers` or `seats`:

* Flights with 0 seats
* Flights with 0 passengers

###Flights with 0 seats

Flights with zero seats could represent private or military flights.  From an airline's perspective, these flights should not be included when trying to predict `passengers` or `seats`.

Out of 3.6M observations, `r sum(flight_edges$seats == 0)` observations have 0 seats (`r round((sum(flight_edges$seats == 0) / nrow(flight_edges)) * 100, 1)`%).

```{r}
#Remove 0-seat observations 
flight_data = subset(flight_edges, flight_edges$seats > 0)
```

###Flights with 0 passengers

Further exploration of the data has also revealed `r sum(flight_data$passengers == 0)` (out of 3.2M) observations with 0 passengers.

```{r echo = FALSE}
flight_data_0p = subset(flight_data, flight_data$passengers == 0)
```

We note that only `r round(nrow(flight_data_0p) / nrow(flight_data) * 100, 2)`% (`r nrow(flight_data_0p)`) of all reamaining 3.2M observations carried 0 passengers.  Of these zero-passenger flights, `r round((sum(flight_data_0p$dist < 500) / nrow(flight_data_0p)) * 100, 2)`% flew less than 500 miles.  In fact, the histogram confirms the logical [business] decision *not* to fly aircraft empty, if at all possible...and for shorter distances if absolutely necessary:

```{r echo=FALSE, fig.height=5, fig.width=7}
hist(flight_data_0p$dist, main = "0-Passenger Distance Histogram",
     xlab = "Distance (miles)",
     ylab = "Frequency",
     col = "darkorange")
```

Airlines occasionally fly empty aircraft for maintenance purposes (for servicing at a different field), or to make an availability adjustment at an airfield where they do not have enough aircraft.  Additionally, military aircraft *will* fly 0-passenger flights (mandatory scheduled routes) where airlines *will not* fly [paid service routes] with 0 passengers.  For these reasons, it makes sense to remove the 0-passenger flights from consideration for future response transformation.

```{r cache = TRUE}
#pp ~ positive passenger values
flight_data_pp = subset(flight_data, flight_data$passengers > 0)
#flight_model = lm(passengers ~ seats * flights + I(dist^2) * I(origin_pop^2) * I(dest_pop^2), data = flight_sub_pp)
```

###Initial sampling

Based on a recommendation overheard in help sessions, we decided to start modeling with a subset of 10,000 observations, without any restrictions or geographical limitation.

At this point, we also remove the informational variables `origin_ICAO`, `dest_ICAO`, `origin_city`, and `dest_city`.  Additionally, since we broke out the date into `year`  and `month.chr` categorical variables, we remove `date` and `month` numeric variables as well.

```{r}
#full 3.2M observations currently stored in `flight_data_pp`
sub_obs = 10000
flight_sub = flight_data_pp[sample(1:nrow(flight_data_pp), sub_obs), -c(1:3, 7, 17, 19)]
```

Although not originally planned, we left `origin_state` and `dest_state` as yet another possible "region"" division.

## Methods

```{r message = FALSE, echo = FALSE}
#these libraries are required for bptest() and shapiro.test, in diagnostics function
library(lmtest)
library(MASS)

#diagnostics function
diagnostics = function(model, pcol = "grey", lcol = "dodgerblue", alpha = 0.05, plotit = TRUE, testit = TRUE) {
  if(plotit == TRUE) {
    par(mfrow = c(1,2))
    plot(fitted(model), resid(model),
         xlab = "Fitted",
         ylab = "Residuals",
         main = "Fitted vs. Residuals",
         col = pcol, 
         pch = 16,
         cex = 0.35)
    abline(h = 0, col = lcol, lwd = 2)
    qqnorm(resid(model), col = pcol)
    qqline(resid(model), col = lcol)
  }
  if(testit == TRUE) {
    shapiro_wilk = shapiro.test(resid(model))
    breusch_pagan = bptest(model)
    list(shapiro_wilk = shapiro_wilk, breusch_pagan = breusch_pagan)
  }
}
```

###Passengers vs. Month (High traffic significance?)

For starters, we were curious to see whether `passengers` could be modeled as a response of `month` as a factor variable, verifying high-traffic seasons of flying.

```{r}
month_model = lm(passengers ~ month.chr, data = flight_sub)
summary(month_model, data = flight_sub)
```

Even though the p-value of this regression (`r pf(summary(month_model)$fstatistic[1], summary(month_model)$fstatistic[2], summary(month_model)$fstatistic[3], lower.tail = FALSE)`) is significant, the simple representation did not prove very fruitful at all, with an adjusted $R^2$ of `r summary(month_model)$adj.r.squared`.  Interestingly, some of the months for which we would expect to see higher travel did have *relatively* lower p values.

###Full-on additive

To see which predictors may be worth including, we first formed a simple additive model considering all predictors, then passed it to AIC & BIC to get a first opinion.

```{r}
flight_model_big = lm(passengers ~ ., data = flight_sub)
n = length(resid(flight_model_big))
flight_model_big_bwd_aic = step(flight_model_big, direction = "backward", trace = 0)
flight_model_big_bwd_bic = step(flight_model_big, direction = "backward", k = log(n), trace = 0)
summary(flight_model_big_bwd_aic)$call
summary(flight_model_big_bwd_bic)$call
```

AIC fails to eliminate the "regional" categorical variables, normally choosing 2 of the three variables `origin_state`, `dest_state`, and `intra_regn`, whilst also keeping `month.chr`.  

BIC eliminates all regional categorical variables, instead preferring `month.chr` as the only categorical variable.  The smaller model may be easier to work with at first, subsequently adding region variables and testing for significance.

Also of note, only BIC keeps `origin_pop` as a predictor; both usually discard `dest_pop`.

###Time to get serious

To get a better idea of how potential predictor variables could be reacting, we took a look at a `pairs` plot:

```{r fig.height=8, fig.width=10, cache = TRUE}
#remove non-numerical columns
pairs(flight_sub[, -c(1:8, 13:14)], col = "dodgerblue")
```

Obvious linear relationships exist in both `seats` and `flights`...finite amounts of seats and flights were flown domestically, and we would expect their distributions to be very similar.

Also apparent is a very clear quadratic relationship between `flights` and `dist`.  This makes sense from an airline's persective as well...more flights fly short distances (saving money), while fewer flights fly longer distances.

We were hoping to *observe* a better relationship between `passengers` and either `origin_pop` or `dest_pop`, but neither shows a distinguishable pattern in this sample.

Knowing a little more about the data allowed us to form initial [large] models to pass to either AIC and/or BIC for selection:

```{r}
#initial model best guess
#flight_model = lm(passengers ~ seats * flights * month.chr + I(dist^2) * I(origin_pop^2) * I(dest_pop^2), data = flight_sub)
flight_model = lm(passengers ~ seats * flights * month.chr * intra_regn + origin_state + dest_state + I(dist^2) * I(origin_pop^2) * I(dest_pop^2), data = flight_sub)

#summary(flight_model)
```

The regression of our initial best guess at a model proves to be significant with a p-value of `r pf(summary(flight_model)$fstatistic[1], summary(flight_model)$fstatistic[2], summary(flight_model)$fstatistic[3], lower.tail = FALSE)`.  Both `seats` and `flights` were expected to be significant, as well as `dist^2`, as observed in the pairs plot.  Also significant was `intra_regn` and the vast majority of its two-way interactions.  `origin_pop` and `dest_pop` were not significant on their own; however, the interaction between `dist^2` and `origin_pop` *was* significant.  The interaction between `dist^2` and `dest_pop` was *not* significant.  This also might explain why BIC throws out the interaction with `dest_pop`.

```{r fig.height=5, fig.width=10, echo = FALSE}
diagnostics(flight_model, testit = FALSE)
```

While it is nice to have so many significant predictors, we appear to have an issue with both homeoscedasticity and normality, confirmed by fitted vs. residuals and Q-Q plots.

We wished to perform a response variable transformation to address the clear patten in the fitted vs. residuals plot.  To determine an appropriate transformation, we ran a Box-Cox log-likelihood plot:

```{r fig.width = 7, fig.height = 5}
boxcox(flight_model, lambda = seq(0.50, 0.68, 1/100))
```

For simplicity's sake, we chose a Box-Cox transformation with $\lambda = 0.55$.  

```{r}
#perform response transformation
flight_model_mod = lm((passengers^0.55 - 1)/0.55 ~ seats * flights * month.chr * intra_regn + origin_state + dest_state + I(dist^2) * I(origin_pop^2) * I(dest_pop^2), data = flight_sub)
n = length(resid(flight_model_mod))

#step selection
flight_model_bwd_aic = step(flight_model_mod, direction = "backward", trace = 0)
flight_model_bwd_bic = step(flight_model_mod, direction = "backward", k = log(n), trace = 0)

summary(flight_model_bwd_aic)$call
summary(flight_model_bwd_aic)$adj.r.squared
summary(flight_model_bwd_bic)$call
summary(flight_model_bwd_bic)$adj.r.squared

diagnostics(flight_model_bwd_aic, testit = FALSE)
```

While the Fitted vs. Residuals and Q-Q plots have improved dramatically, they are not quite ideal; however, they are probably as good as they are going to get, given the Box-Cox transformation we have chosen.

AIC still likes holding on to `origin_state` and `dest_state`, while BIC seems happy to remove them from the model.  Both AIC & BIC retain some sort of region coding, however, as BIC keeps `intra_regn` in its model.
